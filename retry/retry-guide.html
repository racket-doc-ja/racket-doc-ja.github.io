<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Mirrored from docs.racket-lang.org/retry/retry-guide.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:30:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>1&nbsp;The Retry Guide</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="../racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../doc-site.css" title="default"/><script type="text/javascript" src="../scribble-common.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../doc-site.js"></script><script type="text/javascript" src="../local-redirect/local-redirect.js"></script><script type="text/javascript" src="../local-redirect/local-user-redirect.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Retry:<span class="mywbr"> &nbsp;</span> Retrying Arbitrary Computations</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">The Retry Guide</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="retry-reference.html" class="tocviewlink" data-pltdoc="x">The Retry Reference</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>1&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">The Retry Guide</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">1.1&nbsp;</td><td><a href="#%28part._.Intro_to_.Retryers%29" class="tocviewlink" data-pltdoc="x">Intro to Retryers</a></td></tr><tr><td align="right">1.2&nbsp;</td><td><a href="#%28part._retry-predefined%29" class="tocviewlink" data-pltdoc="x">Predefined Retryers</a></td></tr><tr><td align="right">1.3&nbsp;</td><td><a href="#%28part._retry-complex%29" class="tocviewlink" data-pltdoc="x">Building Complex Retryers</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">1.1<tt>&nbsp;</tt></span><a href="#%28part._.Intro_to_.Retryers%29" class="tocsubseclink" data-pltdoc="x">Intro to Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.2<tt>&nbsp;</tt></span><a href="#%28part._retry-predefined%29" class="tocsubseclink" data-pltdoc="x">Predefined Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.2.1<tt>&nbsp;</tt></span><a href="#%28part._retry-print%29" class="tocsubseclink" data-pltdoc="x">Printing Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.2.2<tt>&nbsp;</tt></span><a href="#%28part._.Limiting_.Retryers%29" class="tocsubseclink" data-pltdoc="x">Limiting Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.2.3<tt>&nbsp;</tt></span><a href="#%28part._.Sleeping_.Retryers%29" class="tocsubseclink" data-pltdoc="x">Sleeping Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.3<tt>&nbsp;</tt></span><a href="#%28part._retry-complex%29" class="tocsubseclink" data-pltdoc="x">Building Complex Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.3.1<tt>&nbsp;</tt></span><a href="#%28part._.Retryer_.Composition%29" class="tocsubseclink" data-pltdoc="x">Retryer Composition</a></td></tr><tr><td><span class="tocsublinknumber">1.3.2<tt>&nbsp;</tt></span><a href="#%28part._.Cyclic_.Retryers%29" class="tocsubseclink" data-pltdoc="x">Cyclic Retryers</a></td></tr><tr><td><span class="tocsublinknumber">1.3.3<tt>&nbsp;</tt></span><a href="#%28part._.In_.Depth_.Example__.Cyclic_.Exponential_.Backoff_with_.Jittering%29" class="tocsubseclink" data-pltdoc="x">In Depth Example:<span class="mywbr"> &nbsp;</span> Cyclic Exponential Backoff with Jittering</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">8.6</span></div><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;Retry: Retrying Arbitrary Computations&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Retry: Retrying Arbitrary Computations&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="retry-reference.html" title="forward to &quot;2 The Retry Reference&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;retry-guide&quot;">1<tt>&nbsp;</tt><a name="(part._retry-guide)"></a>The Retry Guide</h3><p>This guide is intended for programmers who are familiar with Racket but new to
working with <a href="#%28tech._retryer%29" class="techoutside" data-pltdoc="x"><span class="techinside">retryers</span></a>. It contains a description of the high
level concepts associated with the <a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">retry</span></a> library, as well as
examples and use cases. For a complete description of the <a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">retry</span></a>
API, see <a href="retry-reference.html" data-pltdoc="x">The Retry Reference</a>.</p><h4 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;Intro_to_Retryers&quot;">1.1<tt>&nbsp;</tt><a name="(part._.Intro_to_.Retryers)"></a>Intro to Retryers</h4><p>Sometimes, code fails. And sometimes, those failures are unpredictable - they
might happen again, they might not. A classic example is attempting to open an
internet connection - there&rsquo;s no way for code to know whether it will succeed or
fail due to network issues and machine failures. In a world of such uncertainty,
we must learn to handle temporary failure gracefully.</p><p>One way to handle temporary failures is by retrying. There are many different
ways to retry operations, but most include some combination of waiting for some
amount of time, logging information about the failure, and limiting the maximum
number of retry attempts. We can define a strategy for retrying by creating a
<a name="(tech._retryer)"></a><span style="font-style: italic">retryer</span>. Retryers are made with the
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer%29%29" class="RktValLink" data-pltdoc="x">retryer</a></span> procedure by combining two other procedures - one that defines
when a failing operation <span class="emph">should</span> be retried, and one that defines
<span class="emph">how</span> to handle the failure. Then, we can call a possibly-failing procedure
with retries by using <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span>.</p><p>First, lets define a helper called <span class="RktSym">make-flaky-procedure</span> that returns a
thunk (a procedure accepting no arguments, like those created by <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=procedures.html%23%2528form._%2528%2528lib._racket%252Ffunction..rkt%2529._thunk%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">thunk</a></span>)
that fails with an exception the first few times its called. This will help us
explore strategies for retrying calls to flaky code.</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define-struct.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._struct%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">struct</a></span><span class="hspace">&nbsp;</span><span class="RktSym">exn:fail:flaky</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._exn%7E3afail%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exn:fail</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">#:transparent</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktSym">num-failures</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-calls</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=boxes.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._box%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">box</a></span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=procedures.html%23%2528form._%2528%2528lib._racket%252Ffunction..rkt%2529._thunk%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">thunk</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._%7E3c%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">&lt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=boxes.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._unbox%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">unbox</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-calls</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">num-failures</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=boxes.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._set-box%2521%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">set-box!</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-calls</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._add1%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">add1</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=boxes.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._unbox%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">unbox</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-calls</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._raise%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">raise</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">exn:fail:flaky</span><span class="hspace">&nbsp;</span><span class="RktVal">"not good enough!"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=contmarks.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._current-continuation-marks%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">current-continuation-marks</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktVal">'</span><span class="RktVal">success</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote></div></p><p>The flaky procedures returned by <span class="RktSym">make-flaky-procedure</span> store the number
of times they&rsquo;ve been called in a <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=boxes.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._box%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">box</a></span>, and increment that number before
throwing an <span class="RktSym">exn:fail:flaky</span> when they&rsquo;re called:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">example-flaky-proc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">example-flaky-proc</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">not good enough!</span></p></td></tr></table></blockquote></div></p><p>Once our flaky procedure is called for the fourth time, it starts returning
<span class="RktVal">'</span><span class="RktVal">success</span>:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">example-flaky-proc</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">not good enough!</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">example-flaky-proc</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">not good enough!</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">example-flaky-proc</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>Now that we have a way to construct flaky code, lets create a
<a href="#%28tech._retryer%29" class="techoutside" data-pltdoc="x"><span class="techinside">retryer</span></a> and use <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span> to automatically call flaky
procedures multiple times:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">my-retryer</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer%29%29" class="RktValLink" data-pltdoc="x">retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">#:should-retry?</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=lambda.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._%7Ece%7Ebb%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">&#955;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">raised</span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:handle</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=lambda.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._%7Ece%7Ebb%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">&#955;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">raised</span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._printf%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">printf</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Failed attempt ~a, message: ~a\n"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._add1%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">add1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._exn-message%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exn-message</a></span><span class="hspace">&nbsp;</span><span class="RktSym">raised</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">my-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Failed attempt 1, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 2, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 3, message: not good enough!</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>A retryer is constructed from two procedures. Both are called during the extent
of <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span> when the procedure given to <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span> fails,
and both are given the thrown exception and the number of previous retries. The
first, the <span class="RktPn">#:should-retry?</span> argument, is called to determine if this
retryer wants to retry the failure. Our retryer ignores both arguments and
always returns true, indicating that <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span> should keep retrying no
matter what happens.</p><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>In a real world application, retrying forever can be dangerous and
should be considered carefully. At the very least, unlimited retries should be
restricted to a very targeted subtype of <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._exn%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exn</a></span> rather than all possible
values that could be <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._raise%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">raise</a></span>d.</p></blockquote></blockquote></blockquote><p>The second, the <span class="RktPn">#:handle</span> argument, is called before retrying to perform
some arbitrary side-effect to handle the thrown exception. Our retryer prints
the message along with how many attempts we&rsquo;ve made.</p><p>Instead of making our own retryers however, this library encourages constructing
retryers through <span class="emph">composition</span>. Described in the next section
<a href="#%28part._retry-predefined%29" data-pltdoc="x">Predefined Retryers</a> are the built in retryers provided by
<a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">retry</span></a> that implement simple targeted functionality. In the
following section <a href="#%28part._retry-complex%29" data-pltdoc="x">Building Complex Retryers</a>, we show how to compose simple retryers
into more complex ones that perform multiple operations.</p><h4 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;retry-predefined&quot;">1.2<tt>&nbsp;</tt><a name="(part._retry-predefined)"></a>Predefined Retryers</h4><p>While <a href="#%28tech._retryer%29" class="techoutside" data-pltdoc="x"><span class="techinside">retryers</span></a> can perform arbitrarily complex operations, most
applications only need to perform a few kinds of tasks when retrying. The
<a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">retry</span></a> library provides procedures out of the box to create
retryers for these tasks. Included are retryers for printing messages, waiting
for certain amounts of time, and limiting the number of retries.</p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;retry-print&quot;">1.2.1<tt>&nbsp;</tt><a name="(part._retry-print)"></a>Printing Retryers</h5><p>The <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._print-exn-retryer%29%29" class="RktValLink" data-pltdoc="x">print-exn-retryer</a></span> procedure takes a function for converting
exception messages and the number of retries into a string and constructs a
retryer. That retryer uses the given function to print a message with
<span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fmisc..rkt%2529._displayln%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">displayln</a></span>:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">retry-failure-to-string</span><span class="hspace">&nbsp;</span><span class="RktSym">msg</span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._format%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Failed attempt ~a, message: ~a"</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._add1%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">add1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">msg</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">printing-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._print-exn-retryer%29%29" class="RktValLink" data-pltdoc="x">print-exn-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktSym">retry-failure-to-string</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">printing-retryer</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Failed attempt 1, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 2, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 3, message: not good enough!</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>Note that only exceptions have messages, but <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._raise%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">raise</a></span>d values might not
necessarily be exceptions. Thus, a retryer created with
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._print-exn-retryer%29%29" class="RktValLink" data-pltdoc="x">print-exn-retryer</a></span> only handles exceptions - any other raised values
are raised normally instead of retried.</p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;Limiting_Retryers&quot;">1.2.2<tt>&nbsp;</tt><a name="(part._.Limiting_.Retryers)"></a>Limiting Retryers</h5><p>The <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._limit-retryer%29%29" class="RktValLink" data-pltdoc="x">limit-retryer</a></span> procedure is relatively simple. Given a maximum
number of times to retry, the returned retryer only handles thrown values if
fewer that that many retries have occurred:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">at-most-four-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._limit-retryer%29%29" class="RktValLink" data-pltdoc="x">limit-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">at-most-four-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktErr">not good enough!</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">at-most-four-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;Sleeping_Retryers&quot;">1.2.3<tt>&nbsp;</tt><a name="(part._.Sleeping_.Retryers)"></a>Sleeping Retryers</h5><p>Often temporary failures are due to factors completely outside our control,
where the only recourse is to wait some amount of time for the issue to fix
itself. For these cases, we can construct retryers that call <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=threads.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._sleep%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">sleep</a></span> to
pause between retries. This library uses Gregor <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._period%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">period</a></span> structures to
determine how long to sleep for, in contrast to the fractional seconds used when
calling <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=threads.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._sleep%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">sleep</a></span> directly. The periods used must satisfy
<span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._time-period%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">time-period?</a></span>.</p><p>The simplest of the sleeping retryers is <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span>. Retryers
returned by this procedure sleep for a constant amount of time (determined by a
period given to <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span>) between retries. In the following
examples we have altered the behavior of <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=threads.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._sleep%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">sleep</a></span> slightly; instead of
actually pausing execution, the amount of seconds to sleep for will be printed
out and no sleeping will occur. If you evaluate these expressions in a normal
Racket REPL, expect long execution times with no output.</p><p><div class="SIntrapara">Example:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._minutes%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">minutes</a></span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 180 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 180 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 180 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>A more general form of retrying with pauses is available via
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-retryer</a></span>. Unlike <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span>,
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-retryer</a></span> accepts a <span class="emph">procedure</span> that is expected to map the
number of previous retries to a <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._time-period%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">time-period?</a></span> value. This allows
sleeping retryers to vary how long they pause between retries. Lets use it to
build a retryer that sleeps for a linearly increasing number of minutes:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sleep-amount</span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._minutes%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">minutes</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._%252A%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">*</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._add1%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">add1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktSym">sleep-amount</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 300 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 600 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 900 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>A very common pattern when attempting to open network connections is to sleep
between failures with <a name="(tech._exponential._backoff)"></a><span style="font-style: italic">exponential backoff</span>.
This means waiting for an exponentially increasing amount of time between
failures. Because of its ubiquity, the <a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">retry</span></a> library provides
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span> for retrying with exponential backoff:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">exponential-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">exponential-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 20 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 40 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>Additionally, three more procedures are provided: <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-retryer/random</a></span>,
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span>, and
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer/random</a></span>. These procedures produce retryers
that sleep for <span class="emph">random</span> amounts of time, up to a maximum of what their
counterpart retryers would sleep for. This is useful for adding
<a name="(tech._jitter)"></a><span style="font-style: italic">jitter</span>: variation in a group of retrying agents
that causes them to fall out of synchronization (see the
<a href="https://en.wikipedia.org/wiki/Thundering_herd_problem">thundering herd problem</a>). Now, lets consider what happens if we take
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span> and add some randomness.</p><p><div class="SIntrapara">Example:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">30</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 7 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 3 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 13 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>The unit of the returned <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._time-period%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">time-period?</a></span> affects the randomness. Returning
a <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._minutes%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">minutes</a></span> period causes a random number of minutes to be chosen as the
sleep amount, while returning the equivalent <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._milliseconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">milliseconds</a></span> period
chooses a random amount of milliseconds. Observe the difference between using
<span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._minutes%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">minutes</a></span><span class="stt"> </span><span class="RktVal">5</span><span class="RktPn">)</span> and <span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="stt"> </span><span class="RktVal">300</span><span class="RktPn">)</span>:</p><p><div class="SIntrapara"><p><div class="SIntrapara">Example:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._minutes%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">minutes</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 0 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 60 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 240 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p></div><div class="SIntrapara"><p><div class="SIntrapara">Example:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">300</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 91 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 150 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 236 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p></div></p><h4 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;retry-complex&quot;">1.3<tt>&nbsp;</tt><a name="(part._retry-complex)"></a>Building Complex Retryers</h4><p>Each of the built-in retryers we&rsquo;ve seen so far in <a href="#%28part._retry-predefined%29" data-pltdoc="x">Predefined Retryers</a> has
a single purpose. However, in the real world we often wish to combine many of
these behaviors. We may wish for a retryer that retries at most three times,
sleeps an increasing amount of time between retries, and prints information
about failures to the console. Instead of reaching for our own custom
implementations as soon as the going gets tough, we can combine our existing
simple retryers together to declaritively construct complex retryers.</p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;Retryer_Composition&quot;">1.3.1<tt>&nbsp;</tt><a name="(part._.Retryer_.Composition)"></a>Retryer Composition</h5><p>The simplest means of combining retryers is <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer-compose%29%29" class="RktValLink" data-pltdoc="x">retryer-compose</a></span>. This
procedure takes a list of retryers and returns one composed retryer, which calls
each given retryer to determine if and how to handle failures. Recall our
<span class="RktSym">printing-retryer</span> from <a href="#%28part._retry-print%29" data-pltdoc="x">Printing Retryers</a>; we can add sleeping with
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer-compose%29%29" class="RktValLink" data-pltdoc="x">retryer-compose</a></span>:</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">composed-retryer</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer-compose%29%29" class="RktValLink" data-pltdoc="x">retryer-compose</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">printing-retryer</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">composed-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Failed attempt 1, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 2, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed attempt 3, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><p>Note that although <span class="RktSym">printing-retryer</span> is the second argument to
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer-compose%29%29" class="RktValLink" data-pltdoc="x">retryer-compose</a></span>, it is called <span class="emph">first</span> when a failure is handled.
This mimics the behavior of function composition with <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=procedures.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Flist..rkt%2529._compose%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">compose</a></span>; retryers
are called in right-to-left order.</p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;Cyclic_Retryers&quot;">1.3.2<tt>&nbsp;</tt><a name="(part._.Cyclic_.Retryers)"></a>Cyclic Retryers</h5><p>In previous sections, we discussed <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span> and the
utility of creating retryers that sleep increasing amounts of time between
retries. This can be troublesome if the retries are unbounded; eventually the
pauses between retries could reach days or weeks. Using <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._cycle-retryer%29%29" class="RktValLink" data-pltdoc="x">cycle-retryer</a></span>,
we can extend retryers with <span class="emph">cyclic</span> behavior so that the number of retries
appears to "reset".</p><p><div class="SIntrapara">Example:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._cycle-retryer%29%29" class="RktValLink" data-pltdoc="x">cycle-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">4</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 20 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 40 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 80 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 20 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 40 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 80 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 10 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 20 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><h5 x-source-module="(lib &quot;retry/scribblings/main.scrbl&quot;)" x-source-pkg="retry" x-part-tag="&quot;In_Depth_Example__Cyclic_Exponential_Backoff_with_Jittering&quot;">1.3.3<tt>&nbsp;</tt><a name="(part._.In_.Depth_.Example__.Cyclic_.Exponential_.Backoff_with_.Jittering)"></a>In Depth Example: Cyclic Exponential Backoff with Jittering</h5><p>Putting together all the concepts we&rsquo;ve learned so far, let&rsquo;s consider how a web
server might reliable handle the failure of a database it retrieves information
from. It would be most unfortunate if a small temporary network issue caused our
website to permanently fail. There&rsquo;s a host of other constraints as well:</p><ul><li><p>A small hiccup may be resolved in seconds, we shouldn&rsquo;t be waiting for
minutes or hours after our first retry.</p></li><li><p>Bandwidth is expensive. If the database is down for hours, retrying every
few seconds can be costly and lead to network congestion.</p></li><li><p>Reconnection should occur quickly when the database comes back online.</p></li><li><p>There may be hundreds or thousands of instances of our website trying to
connect, if they all make requests in synchronization the spiky network load
can cause failures and overloads.</p></li><li><p>We should only retry when faced with <span class="emph">network</span> errors. Permission
and configuration errors are far less likely to resolve themselves, and by
retrying forever we mask their existence.</p></li></ul><p>To address these constraints, we&rsquo;ll combine three main elements in our retry
strategy:</p><ul><li><p>Adding a quick test of the raised exception to verify we&rsquo;re dealing with
a network issue instead of some other more-permanent problem.</p></li><li><p><a href="#%28tech._exponential._backoff%29" class="techoutside" data-pltdoc="x"><span class="techinside">Exponential backoff</span></a> with
<span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span>. This lets us reconnect quickly in the
event of small hiccups, but we won&rsquo;t make unnecessary requests when faced with
a large outage.</p></li><li><p>Cycling the backoff with <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._cycle-retryer%29%29" class="RktValLink" data-pltdoc="x">cycle-retryer</a></span>. Using plain exponential
backoff can result in large waits to reconnect when the database comes back
online. If the time between retries doubles, then a one-hour outage in the
database could trigger a two-hour outage in our website: reconnection is
attempted just before the database comes back online and fails with the next
retry not occurring for another hour. Cycling sets an upper bound on how long
we wait between retries.</p></li><li><p>Adding <a href="#%28tech._jitter%29" class="techoutside" data-pltdoc="x"><span class="techinside">jitter</span></a> with <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span>.
When a database outage first occurs, our websites will attempt to reconnect
(mostly) in sync with each other. By adding jitter they will gradually fall
out of resynchronization, spreading the network load around as we reach the
larger periods between retries with our exponential backoff.</p></li></ul><p>By combining these elements (along with <span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._print-exn-retryer%29%29" class="RktValLink" data-pltdoc="x">print-exn-retryer</a></span>), we end up
with a retryer looking something like this. Note that we&rsquo;re assuming an
<span class="RktSym">exn:fail:flaky</span> is raised instead of <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=exns.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._exn%7E3afail%7E3anetwork%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exn:fail:network</a></span>, this
helps us demonstrate our retryer.</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">database-retry-message</span><span class="hspace">&nbsp;</span><span class="RktSym">exn-msg</span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._format%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">format</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Failed database connection attempt ~a, message: ~a"</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=generic-numbers.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._add1%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">add1</a></span><span class="hspace">&nbsp;</span><span class="RktSym">num-previous-retries</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">exn-msg</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">database-retryer</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer-compose%29%29" class="RktValLink" data-pltdoc="x">retryer-compose</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._cycle-retryer%29%29" class="RktValLink" data-pltdoc="x">cycle-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-exponential-retryer%29%29" class="RktValLink" data-pltdoc="x">sleep-exponential-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">8</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._sleep-const-retryer%2Frandom%29%29" class="RktValLink" data-pltdoc="x">sleep-const-retryer/random</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=gregor&amp;rel=period.html%23%2528def._%2528%2528lib._gregor%252Fperiod..rkt%2529._seconds%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">seconds</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._print-exn-retryer%29%29" class="RktValLink" data-pltdoc="x">print-exn-retryer</a></span><span class="hspace">&nbsp;</span><span class="RktSym">database-retry-message</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._retryer%29%29" class="RktValLink" data-pltdoc="x">retryer</a></span><span class="hspace">&nbsp;</span><span class="RktPn">#:should-retry?</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=lambda.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._%7Ece%7Ebb%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">&#955;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">exn:fail:flaky?</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr></table></blockquote></div></p><p>Lets test out this retryer with different outage scenarios, simulated with
<span class="RktSym">make-flaky-procedure</span>.</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">database-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Failed database connection attempt 1, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 0 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 2, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 2 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 3, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 4 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 4 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="retry-reference.html#%28def._%28%28lib._retry%2Fmain..rkt%29._call%2Fretry%29%29" class="RktValLink" data-pltdoc="x">call/retry</a></span><span class="hspace">&nbsp;</span><span class="RktSym">database-retryer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">make-flaky-procedure</span><span class="hspace">&nbsp;</span><span class="RktPn">#:num-failures</span><span class="hspace">&nbsp;</span><span class="RktVal">10</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Failed database connection attempt 1, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 4 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 2, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 2 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 3, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 4 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 4 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 4, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 3 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 8 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 5, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 16 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 6, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 32 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 7, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 0 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 64 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 8, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 3 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 128 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 9, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 0 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Failed database connection attempt 10, message: not good enough!</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 1 seconds...</span></p></td></tr><tr><td><p><span class="RktOut">Sleeping for 2 seconds...</span></p></td></tr></table></td></tr><tr><td><p><span class="RktRes">'success</span></p></td></tr></table></blockquote></div></p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="index.html" title="backward to &quot;Retry: Retrying Arbitrary Computations&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Retry: Retrying Arbitrary Computations&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="retry-reference.html" title="forward to &quot;2 The Retry Reference&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body>
<!-- Mirrored from docs.racket-lang.org/retry/retry-guide.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:30:34 GMT -->
</html>