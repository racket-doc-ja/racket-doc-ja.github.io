<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Mirrored from docs.racket-lang.org/disposable/Reusing_Disposables_with_Pools.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:25:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2&nbsp;Reusing Disposables with Pools</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="../racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../doc-site.css" title="default"/><script type="text/javascript" src="../scribble-common.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../doc-site.js"></script><script type="text/javascript" src="../local-redirect/local-redirect.js"></script><script type="text/javascript" src="../local-redirect/local-user-redirect.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Disposable Values</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Basic_Disposable_API_and_Concepts.html" class="tocviewlink" data-pltdoc="x">Basic Disposable API and Concepts</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">Reusing Disposables with Pools</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="Transient_Values.html" class="tocviewlink" data-pltdoc="x">Transient Values</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="Batteries-Included_Disposables.html" class="tocviewlink" data-pltdoc="x">Batteries-<wbr></wbr>Included Disposables</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>2&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">Reusing Disposables with Pools</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">2.1&nbsp;</td><td><a href="#%28part._gpvl%29" class="tocviewlink" data-pltdoc="x">Global Pools with Virtual Leases</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><a href="#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable-pool%29%29" class="tocsubnonseclink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">disposable-<wbr></wbr>pool</span></span></a></td></tr><tr><td><span class="tocsublinknumber">2.1<tt>&nbsp;</tt></span><a href="#%28part._gpvl%29" class="tocsubseclink" data-pltdoc="x">Global Pools with Virtual Leases</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">8.6</span></div><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Basic_Disposable_API_and_Concepts.html" title="backward to &quot;1 Basic Disposable API and Concepts&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Disposable Values&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Transient_Values.html" title="forward to &quot;3 Transient Values&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3 x-source-module="(lib &quot;disposable/scribblings/main.scrbl&quot;)" x-source-pkg="disposable" x-part-tag="&quot;Reusing_Disposables_with_Pools&quot;">2<tt>&nbsp;</tt><a name="(part._.Reusing_.Disposables_with_.Pools)"></a>Reusing Disposables with Pools</h3><p>Disposable values are often expensive to allocate and deallocate. Certain access
and isolation patterns such as the per-thread instances created by
<span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-virtual%29%29" class="RktValLink" data-pltdoc="x">acquire-virtual</a></span> result in a large amount of allocation and deallocation
of short-lived instances of disposables. To help support these use patterns, the
<a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">disposable</span></a> library provides
<a name="(tech._pool)"></a><span style="font-style: italic">disposable pools</span>. Pools encapsulate a collection
of instances of a disposable that are <span class="emph">leased</span> out when allocated and
returned to the pool after use without being deallocated. Because this can
result in permanently storing idle values in the pool without deallocating them,
the pool <span class="emph">itself</span> is a disposable which allocates a nested disposable. The
nested disposable allocated by the pool leases values from the pool when
allocating. Various parameters are provided for tweaking the configuration of
the pool&rsquo;s size and tolerance of unused values.</p><p>All of the bindings documented in this section are provided by
<a href="index.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">disposable</span></a>.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>procedure</p></div></div><table cellspacing="0" cellpadding="0" class="prototype RForeground"><tr><td valign="top"><span class="RktPn">(</span><a name="(def._((lib._disposable/main..rkt)._disposable-pool))"></a><span title="Provided from: disposable | Package: disposable"><span class="RktSym"><a href="#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable-pool%29%29" class="RktValDef RktValLink" data-pltdoc="x">disposable-pool</a></span></span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">disp</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span><span class="RktOpt">[</span></td><td valign="top"><span class="RktPn">#:max</span><span class="hspace">&nbsp;</span><span class="RktVar">max</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktPn">#:max-idle</span><span class="hspace">&nbsp;</span><span class="RktVar">max-idle</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktPn">#:sync-release?</span><span class="hspace">&nbsp;</span><span class="RktVar">sync-release?</span><span class="RktOpt">]</span><span class="RktPn">)</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr></table></blockquote></td></tr><tr><td><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable%2Fc%29%29" class="RktValLink" data-pltdoc="x">disposable/c</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable~3f%29%29" class="RktValLink" data-pltdoc="x">disposable?</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">disp</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable~3f%29%29" class="RktValLink" data-pltdoc="x">disposable?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">max</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528def._%2528%2528lib._racket%252Fcontract%252Fbase..rkt%2529._or%252Fc%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=number-types.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._exact-nonnegative-integer%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exact-nonnegative-integer?</a></span><span class="hspace">&nbsp;</span><span class="RktVal">+inf.0</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">+inf.0</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">max-idle</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=data-structure-contracts.html%23%2528def._%2528%2528lib._racket%252Fcontract%252Fbase..rkt%2529._or%252Fc%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=number-types.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._exact-nonnegative-integer%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">exact-nonnegative-integer?</a></span><span class="hspace">&nbsp;</span><span class="RktVal">+inf.0</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">10</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">sync-release?</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=booleans.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._boolean%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">boolean?</a></span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr></table></blockquote></div><div class="SIntrapara">Returns a <a href="Basic_Disposable_API_and_Concepts.html#%28tech._disposable%29" class="techoutside" data-pltdoc="x"><span class="techinside">disposable</span></a> that allocates <a href="#%28tech._pool%29" class="techoutside" data-pltdoc="x"><span class="techinside">pools</span></a> of
values using <span class="RktVar">disp</span>. The returned disposable allocates a new pool and
returns a <span class="emph">lease</span> disposable that leases values from the pool. Upon
deallocation, the lease disposable returns the values to the pool as
<span class="emph">unused values</span>. Unused values are reused for future leases. Returning a
leased value to the pool will deallocate the value instead if the number of
unused values is greater than <span class="RktVar">max-idle</span>.</div></p><p>If no idle values are available and more than <span class="RktVar">max</span> values are already
in the pool, attempting to lease a value will block until a pooled value
becomes available. When the pool disposable is deallocated, all values in the
pool are deallocated and removed from the pool. Allocation of values by the
pool is not concurrent; the pool will allocate multiple values serially if
multiple clients request values concurrently.</p><p>Allocation and deallocation by the pool sets <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=custodians.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._current-custodian%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">current-custodian</a></span> to the
custodian that was current when when the <span class="emph">pool</span> was allocated, not when
a <span class="emph">lease</span> for that pool is allocated. As a result, different clients of a
pool with different custodians may use values from the pool that are not
managed by their custodian. Because a lease disposable is only obtainable by
allocating a pool it&rsquo;s expected that the leasing threads have custodians that
are subordinate to the pool&rsquo;s custodian, ensuring that a custodian shutdown of
either the pool&rsquo;s custodian or any lease&rsquo;s custodian does not result in a lease
returning allocated values whose custodian-managed resources (e.g. threads,
ports, etc.) have already been reclaimed.</p><p>If <span class="RktVar">sync-release?</span> if <span class="RktVal">#f</span> (the default) leased values are
returned to the pool asynchronously, preventing the leasing thread from
potentially blocking on an expensive deallocation. This is not always
desireable; in testing it&rsquo;s useful to have predictable deallocation, and when
using <span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire%29%29" class="RktValLink" data-pltdoc="x">acquire</a></span> or <span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-virtual%29%29" class="RktValLink" data-pltdoc="x">acquire-virtual</a></span> where the lease is already
disposed asynchronously it&rsquo;s unnecessary.</p><p><div class="SIntrapara">Examples:</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">ex-pool</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable-pool%29%29" class="RktValLink" data-pltdoc="x">disposable-pool</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Batteries-Included_Disposables.html#%28def._%28%28lib._disposable%2Fexample..rkt%29._example-disposable%29%29" class="RktValLink" data-pltdoc="x">example-disposable</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28form._%28%28lib._disposable%2Fmain..rkt%29._with-disposable%29%29" class="RktStxLink" data-pltdoc="x">with-disposable</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">ex</span><span class="hspace">&nbsp;</span><span class="RktSym">ex-pool</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fmisc..rkt%2529._displayln%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">displayln</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Pool initialized"</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28form._%28%28lib._disposable%2Fmain..rkt%29._with-disposable%29%29" class="RktStxLink" data-pltdoc="x">with-disposable</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">ex</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._printf%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">printf</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Acquired ~v from the pool\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28form._%28%28lib._disposable%2Fmain..rkt%29._with-disposable%29%29" class="RktStxLink" data-pltdoc="x">with-disposable</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">ex</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">y</span><span class="hspace">&nbsp;</span><span class="RktSym">ex</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._printf%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">printf</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Acquired ~v and ~v from the pool\n"</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">y</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Writing.html%23%2528def._%2528%2528lib._racket%252Fprivate%252Fmisc..rkt%2529._displayln%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">displayln</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"Pool shutdown commencing"</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0"><tr><td><p><span class="RktOut">Pool initialized</span></p></td></tr><tr><td><p><span class="RktOut">Allocated 11</span></p></td></tr><tr><td><p><span class="RktOut">Acquired 11 from the pool</span></p></td></tr><tr><td><p><span class="RktOut">Allocated 98</span></p></td></tr><tr><td><p><span class="RktOut">Acquired 98 and 11 from the pool</span></p></td></tr><tr><td><p><span class="RktOut">Pool shutdown commencing</span></p></td></tr><tr><td><p><span class="RktOut">Deallocated 11</span></p></td></tr><tr><td><p><span class="RktOut">Deallocated 98</span></p></td></tr></table></td></tr></table></blockquote></div></p><h4 x-source-module="(lib &quot;disposable/scribblings/main.scrbl&quot;)" x-source-pkg="disposable" x-part-tag="&quot;gpvl&quot;">2.1<tt>&nbsp;</tt><a name="(part._gpvl)"></a>Global Pools with Virtual Leases</h4><p><a href="Basic_Disposable_API_and_Concepts.html#%28tech._virtual._instance%29" class="techoutside" data-pltdoc="x"><span class="techinside">Virtual instances</span></a> of disposables are exceptionally convenient,
essentially providing thread-isolated resources "for free". However, for
contexts where short lived threads are created very frequently (such as web
servers), resource allocation and deallocation may be much more expensive than
the cost of the work the thread performs with that resource. By combining
<span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-virtual%29%29" class="RktValLink" data-pltdoc="x">acquire-virtual</a></span> with a <a href="#%28tech._pool%29" class="techoutside" data-pltdoc="x"><span class="techinside">pooled disposable</span></a> constructed by
<span class="RktSym"><a href="#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable-pool%29%29" class="RktValLink" data-pltdoc="x">disposable-pool</a></span>, we can get the best of both worlds: individual threads
have isolated access to resources, but resources are automatically reused by
threads to minimize expensive allocation and deallocation. Furthermore, by
defining and acquiring the pool globally in a module with
<span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-global%29%29" class="RktValLink" data-pltdoc="x">acquire-global</a></span>, we can hide the use of disposables from client modules
completely:</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">pool-lease</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-global%29%29" class="RktValLink" data-pltdoc="x">acquire-global</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#%28def._%28%28lib._disposable%2Fmain..rkt%29._disposable-pool%29%29" class="RktValLink" data-pltdoc="x">disposable-pool</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Batteries-Included_Disposables.html#%28def._%28%28lib._disposable%2Fexample..rkt%29._example-disposable%29%29" class="RktValLink" data-pltdoc="x">example-disposable</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:sync-release?</span><span class="hspace">&nbsp;</span><span class="RktVal">#t</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">get-resource</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="Basic_Disposable_API_and_Concepts.html#%28def._%28%28lib._disposable%2Fmain..rkt%29._acquire-virtual%29%29" class="RktValLink" data-pltdoc="x">acquire-virtual</a></span><span class="hspace">&nbsp;</span><span class="RktSym">pool-lease</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._provide%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">provide</a></span><span class="hspace">&nbsp;</span><span class="RktSym">get-resource</span><span class="RktPn">)</span></td></tr></table></blockquote><p>Clients need only call <span class="RktPn">(</span><span class="RktSym">get-resource</span><span class="RktPn">)</span> to obtain a thread-specific
allocated value. The pool is completely disposed only when the program is about
to exit (more specifically, when the associated <a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=plumbers.html%23%2528tech._plumber%2529&amp;version=8.6" class="techoutside Sq" data-pltdoc="x"><span class="techinside">plumber</span></a> is
flushed). This is called the <span class="emph">global pool with virtual lease</span> pattern, and
is appropriate for reusable resources accessed in isolation by short-lived tasks
in a long-running program.</p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Basic_Disposable_API_and_Concepts.html" title="backward to &quot;1 Basic Disposable API and Concepts&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Disposable Values&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Transient_Values.html" title="forward to &quot;3 Transient Values&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body>
<!-- Mirrored from docs.racket-lang.org/disposable/Reusing_Disposables_with_Pools.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:25:36 GMT -->
</html>