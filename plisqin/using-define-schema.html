<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Mirrored from docs.racket-lang.org/plisqin/using-define-schema.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:29:45 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>2&nbsp;Using define-schema</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="../racket.css" title="default"/><link rel="stylesheet" type="text/css" href="PStyles.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="../doc-site.css" title="default"/><script type="text/javascript" src="../scribble-common.js"></script><script type="text/javascript" src="PScripts.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../manual-racket.js"></script><script type="text/javascript" src="../doc-site.js"></script><script type="text/javascript" src="../local-redirect/local-redirect.js"></script><script type="text/javascript" src="../local-redirect/local-user-redirect.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Plisqin</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Read_Me_First.html" class="tocviewlink" data-pltdoc="x">Read Me First</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">Using define-<wbr></wbr>schema</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="Aggregates.html" class="tocviewlink" data-pltdoc="x">Aggregates</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="Nullability.html" class="tocviewlink" data-pltdoc="x">Nullability</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Refactoring_Recipes.html" class="tocviewlink" data-pltdoc="x">Refactoring Recipes</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Reference.html" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="research-language.html" class="tocviewlink" data-pltdoc="x">Plisqin as a Research Language</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>2&nbsp;</td><td><a href="#" class="tocviewselflink" data-pltdoc="x">Using define-<wbr></wbr>schema</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">2.1&nbsp;</td><td><a href="#%28part._.Teaser%29" class="tocviewlink" data-pltdoc="x">Teaser</a></td></tr><tr><td align="right">2.2&nbsp;</td><td><a href="#%28part._.Getting_.Started%29" class="tocviewlink" data-pltdoc="x">Getting Started</a></td></tr><tr><td align="right">2.3&nbsp;</td><td><a href="#%28part._.The_.Tasks%29" class="tocviewlink" data-pltdoc="x">The Tasks</a></td></tr><tr><td align="right">2.4&nbsp;</td><td><a href="#%28part._schema-generation%29" class="tocviewlink" data-pltdoc="x">Appendix A:<span class="mywbr"> &nbsp;</span> Generating the Initial Schema Definition</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">2.1<tt>&nbsp;</tt></span><a href="#%28part._.Teaser%29" class="tocsubseclink" data-pltdoc="x">Teaser</a></td></tr><tr><td><span class="tocsublinknumber">2.2<tt>&nbsp;</tt></span><a href="#%28part._.Getting_.Started%29" class="tocsubseclink" data-pltdoc="x">Getting Started</a></td></tr><tr><td><span class="tocsublinknumber">2.3<tt>&nbsp;</tt></span><a href="#%28part._.The_.Tasks%29" class="tocsubseclink" data-pltdoc="x">The Tasks</a></td></tr><tr><td><span class="tocsublinknumber">2.3.1<tt>&nbsp;</tt></span><a href="#%28part._.Task_1__.Subcategories___.Categories%29" class="tocsubseclink" data-pltdoc="x">Task 1:<span class="mywbr"> &nbsp;</span> Subcategories &amp; Categories</a></td></tr><tr><td><span class="tocsublinknumber">2.3.2<tt>&nbsp;</tt></span><a href="#%28part._.Task_2__.Products___.Subcategories___.Categories%29" class="tocsubseclink" data-pltdoc="x">Task 2:<span class="mywbr"> &nbsp;</span> Products &amp; Subcategories &amp; Categories</a></td></tr><tr><td><span class="tocsublinknumber">2.3.3<tt>&nbsp;</tt></span><a href="#%28part._.Task_3__.Products_with_.Non-.Zero_.Sales%29" class="tocsubseclink" data-pltdoc="x">Task 3:<span class="mywbr"> &nbsp;</span> Products with Non-<wbr></wbr>Zero Sales</a></td></tr><tr><td><span class="tocsublinknumber">2.3.4<tt>&nbsp;</tt></span><a href="#%28part._.Task_4__.Sales_by_.Product%29" class="tocsubseclink" data-pltdoc="x">Task 4:<span class="mywbr"> &nbsp;</span> Sales by Product</a></td></tr><tr><td><span class="tocsublinknumber">2.3.5<tt>&nbsp;</tt></span><a href="#%28part._.Task_5__.Sales_by_.Subcategory%29" class="tocsubseclink" data-pltdoc="x">Task 5:<span class="mywbr"> &nbsp;</span> Sales by Subcategory</a></td></tr><tr><td><span class="tocsublinknumber">2.3.6<tt>&nbsp;</tt></span><a href="#%28part._.Task_6__.Sales_by_.Anything%29" class="tocsubseclink" data-pltdoc="x">Task 6:<span class="mywbr"> &nbsp;</span> Sales by Anything</a></td></tr><tr><td><span class="tocsublinknumber">2.3.7<tt>&nbsp;</tt></span><a href="#%28part._.Task_7__.Sales_by_.Anything_with_.Date_.Range%29" class="tocsubseclink" data-pltdoc="x">Task 7:<span class="mywbr"> &nbsp;</span> Sales by Anything with Date Range</a></td></tr><tr><td><span class="tocsublinknumber">2.3.7.1<tt>&nbsp;</tt></span><a href="#%28part._ec3%29" class="tocsubseclink" data-pltdoc="x">Extra Credit 1</a></td></tr><tr><td><span class="tocsublinknumber">2.3.7.2<tt>&nbsp;</tt></span><a href="#%28part._ec1%29" class="tocsubseclink" data-pltdoc="x">Extra Credit 2 (More Challenging)</a></td></tr><tr><td><span class="tocsublinknumber">2.4<tt>&nbsp;</tt></span><a href="#%28part._schema-generation%29" class="tocsubseclink" data-pltdoc="x">Appendix A:<span class="mywbr"> &nbsp;</span> Generating the Initial Schema Definition</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">8.6</span></div><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Read_Me_First.html" title="backward to &quot;1 Read Me First&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Plisqin&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Aggregates.html" title="forward to &quot;3 Aggregates&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;using-define-schema&quot;">2<tt>&nbsp;</tt><a name="(part._using-define-schema)"></a>Using define-schema</h3><p>For this walkthrough, you are a new employee at AdventureWorks.
AdventureWorks is a fictional company that sells bicycles and related products.
The company has a mature database, but the SQL that has been written so far
is scattered all over the place, making it difficult to find and reuse.</p><p>Your boss is going to ask you for a series of reports.
As you produce these reports, you will capture certain facts about this
database using <span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._define-schema%29%29" class="RktStxLink" data-pltdoc="x">define-schema</a></span>, making it easier for yourself and
other programmers to find and reuse them.
You will also learn how Plisqin offers opportunities for code reuse that
are simply impossible using plain SQL.</p><h4 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Teaser&quot;">2.1<tt>&nbsp;</tt><a name="(part._.Teaser)"></a>Teaser</h4><p><div class="SIntrapara">Here is a preview of what you will be able to do by the end of this walkthrough.
Imagine that your boss asks to find the top 3 best-selling Products
of all-time, showing Product Name, Category Name, and Total Sales.
Thanks to the reusable definitions you have already captured using
<span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._define-schema%29%29" class="RktStxLink" data-pltdoc="x">define-schema</a></span>, it is this easy:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">3</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">TotalSales</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">TotalSales</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select p.Name as ProductName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt">from Product p</span></p></td></tr><tr><td><p><span class="stt">left join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select detailsG.ProductID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by detailsG.ProductID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 = p.ProductID)</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (p.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = p.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">left join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by round(detailsG.__INJECT1, 2) desc</span></p></td></tr><tr><td><p><span class="stt">limit 3</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductName</p></td><td><p>CategoryName</p></td><td><p>TotalSales</p></td></tr><tr><td><p>Mountain-200 Black, 38</p></td><td><p>Bikes</p></td><td><p>4400592.8</p></td></tr><tr><td><p>Mountain-200 Black, 42</p></td><td><p>Bikes</p></td><td><p>4009494.76</p></td></tr><tr><td><p>Mountain-200 Silver, 38</p></td><td><p>Bikes</p></td><td><p>3693678.03</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>Click on "Show SQL" and you might be surprised!
The generated SQL is much larger than the Plisqin query.
This may seem like "too much magic" right now, but once you learn how it works
it is actually pretty formulaic.</p><h4 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Getting_Started&quot;">2.2<tt>&nbsp;</tt><a name="(part._.Getting_.Started)"></a>Getting Started</h4><p><div class="SIntrapara">Start a new file using <span class="stt">#lang racket</span>.
Save it as aw-schema.rkt, short for "AdventureWorks schema".
Add the the following code to this file:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">require</a></span><span class="hspace">&nbsp;</span><span class="RktSym">plisqin</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._prefix-in%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">prefix-in</a></span><span class="hspace">&nbsp;</span><span class="RktSym">aw:</span><span class="hspace">&nbsp;</span><span class="RktSym">plisqin-examples/adventure-works</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">You should now have access to the <span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span> procedure from your
REPL. This allows you to execute a query against the SQLite database.
To make sure everything is set up correctly, try asking SQLite what time it is:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"select datetime('now')"</span><span class="RktPn">)</span></p></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select datetime('now')</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>datetime('now')</p></td></tr><tr><td><p>2022-08-08 10:47:47</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>If you really want to know how to automatically generate this, see
<a href="#%28part._schema-generation%29" data-pltdoc="x">Appendix A: Generating the Initial Schema Definition</a>.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara">OK, the first thing we need to add to our schema definition is the
table and column information.
There are ways to automatically inspect the database and generate the initial
schema definition, but that is not what we are interested in right now.
You can just use <a href="https://raw.githubusercontent.com/default-kramer/plisqin-tutorials/e844825b48137553246c64e73516d880b9068825/define-schema-answer-key/aw-schema.rkt">this file</a> as your starting aw-schema.rkt file.</div></p><p><div class="SIntrapara">Save, Run, and the following query should now work on your REPL:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">pc</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">pc</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select pc.Name as Name</span></p></td></tr><tr><td><p><span class="stt">from ProductCategory pc</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>Name</p></td></tr><tr><td><p>Bikes</p></td></tr><tr><td><p>Components</p></td></tr><tr><td><p>Clothing</p></td></tr><tr><td><p>Accessories</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>Now that aw-schema.rkt is somewhat large, DrRacket may take a long time to run it.
For this reason, I recommend that you <span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=require.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._require%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">require</a></span> it from another file,
where you will do any work that does not require a change to the
<span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._define-schema%29%29" class="RktStxLink" data-pltdoc="x">define-schema</a></span> code.
(The answer keys that I will share with you do not follow this advice.)</p><p><div class="SIntrapara">There are a few REPL tricks you should learn before proceeding.
The first identifier we passed into <span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._define-schema%29%29" class="RktStxLink" data-pltdoc="x">define-schema</a></span> was
<span class="RktSym">adventure-works-schema</span>. This procedure is designed to be used at
the REPL as a manual alternative to autocomplete.
For example, if you want to know what procedures exist that accept a
ProductCategory, you can ask using the REPL:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">_</span><span class="hspace">&nbsp;</span><span class="RktVal">ProductCategory</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'(ModifiedDate Name ProductCategoryID rowguid)</span></p></td></tr></table></blockquote></div></p><p><div class="SIntrapara">You can also ask what types of argument the ProductCategoryID procedure accepts.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktVal">_</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'(ProductCategory ProductSubcategory)</span></p></td></tr></table></blockquote></div></p><p>(The previous REPL interaction is very useful for discovering relationships
between tables in this database. This is one reason that I prefer primary
key columns to be named like "ProductCategoryID" rather than "ID".)</p><p><div class="SIntrapara">There is one final REPL trick which lists all the tables.
The output of this will be long, so here is the command only:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">tables</span><span class="RktPn">)</span></p></blockquote></div></p><h4 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;The_Tasks&quot;">2.3<tt>&nbsp;</tt><a name="(part._.The_.Tasks)"></a>The Tasks</h4><p><div class="SIntrapara">Your boss is going to assign you some tasks.
For each task, you will
</div><div class="SIntrapara"><ol><li><p>Create a query.</p></li><li><p>Repeatedly refactor that query.
In this part, you will add definitions to your aw-schema.rkt file.</p></li><li><p>Recap and verify that your refactorings were correct.
Here I will provide an answer key that you can check.</p></li><li><p>Proceed to the next task.</p></li></ol></div></p><p>During refactoring, I will link you to refactoring recipes that you will follow.
These recipes are meant to be very thorough.
As you build confidence with the recipes, you might start taking shortcuts.
This is fine. You can use the Recap to make sure you are in sync.</p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_1__Subcategories___Categories&quot;">2.3.1<tt>&nbsp;</tt><a name="(part._.Task_1__.Subcategories___.Categories)"></a>Task 1: Subcategories &amp; Categories</h5><p><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">I want to see a list of Subcategories with the Category that they belong to.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></p><p><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>Remember you can use <span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">tables</span><span class="RktPn">)</span>
to list all the tables.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara">We need to create a query.
The first step is to determine which table we need to query.
The <span class="RktSym">ProductSubcategory</span> table looks promising.
Let&rsquo;s see what it contains:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.*</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductSubcategoryID</p></td><td><p>ProductCategoryID</p></td><td><p>Name</p></td><td><p>rowguid</p></td><td><p>ModifiedDate</p></td></tr><tr><td><p>1</p></td><td><p>1</p></td><td><p>Mountain Bikes</p></td><td><p>{2D364ADE-264A-433C-B092-4FCBF3804E01}</p></td><td><p>2008-04-30 00:00:00</p></td></tr><tr><td><p>2</p></td><td><p>1</p></td><td><p>Road Bikes</p></td><td><p>{000310C0-BCC8-42C4-B0C3-45AE611AF06B}</p></td><td><p>2008-04-30 00:00:00</p></td></tr><tr><td><p>3</p></td><td><p>1</p></td><td><p>Touring Bikes</p></td><td><p>{02C5061D-ECDC-4274-B5F1-E91D76BC3F37}</p></td><td><p>2008-04-30 00:00:00</p></td></tr><tr><td><p>4</p></td><td><p>2</p></td><td><p>Handlebars</p></td><td><p>{3EF2C725-7135-4C85-9AE6-AE9A3BDD9283}</p></td><td><p>2008-04-30 00:00:00</p></td></tr><tr><td><p>5</p></td><td><p>2</p></td><td><p>Bottom Brackets</p></td><td><p>{A9E54089-8A1E-4CF5-8646-E3801F685934}</p></td><td><p>2008-04-30 00:00:00</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p><div class="SIntrapara">This is a good start.
Your boss didn&rsquo;t say exactly which columns he wants to see, but he did say
to include "the Category".
It looks like ProductCategoryID is a foreign key.
(Any column that ends in "ID" is probably a primary key or foreign key.)
We can check if any other tables have a ProductCategoryID as follows:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktVal">_</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'(ProductCategory ProductSubcategory)</span></p></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Based on the names, we conclude that ProductCategoryID is the primary key
of the ProductCategory table.
And we conclude that each ProductSubcategory record points to a single
ProductCategory record via the ProductCategoryID column.
We need to add a join to our query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">You can run that query, but it will produce the same result set.
Even though we added a join, the query does not contain any <span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span>
clauses, so it just shows the primary table by default.
(The primary table is <span class="RktSym">ProductSubcategory</span> here.)
Let&rsquo;s add some <span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span> clauses to control which columns get displayed:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as Name</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as Name</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (cat.ProductCategoryID = subcat.ProductCategoryID)</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>Name</p></td><td><p>Name</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Touring Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Handlebars</p></td><td><p>Components</p></td></tr><tr><td><p>Bottom Brackets</p></td><td><p>Components</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>Now the query seems to be returning the correct data.
We saw the "Mountain Bikes" subcategory earlier, but now we also see that it
belongs to the "Bikes" category.
One obvious problem is that both columns are shown as "Name".
We will immediately fix that during refactoring.</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring</span></div><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._ds~3arename%29" data-pltdoc="x">Name Clarification</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">SubcategoryName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._ds~3arename%29" data-pltdoc="x">Name Clarification</a> recipe again to create the
following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductCategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">CategoryName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">That looks good. But we are not done refactoring.
Use the <a href="Refactoring_Recipes.html#%28part._join1-~3eschema%29" data-pltdoc="x">Singular Join -&gt; Schema Definition</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">ProductCategory</span></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">cat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">But we are still not done refactoring.
Use the <a href="Refactoring_Recipes.html#%28part._join-~3einline%29" data-pltdoc="x">Inline Join</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="PStrike"><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="stt"> </span><span class="RktSym">cat</span><span class="stt"> </span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">ProductCategory</span></span><span class="highlighted"><span class="stt"> </span></span><span class="highlighted"><span class="RktSym">subcat</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">ProductCategory</span></span><span class="highlighted"><span class="hspace">&nbsp;</span></span><span class="highlighted"><span class="RktSym">subcat</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>But we are still not done refactoring.
Use the <a href="Refactoring_Recipes.html#%28part._scalar-flattening%29" data-pltdoc="x">Scalar Flattening</a> recipe to create the following equivalent query:</p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">CategoryName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Touring Bikes</p></td><td><p>Bikes</p></td></tr><tr><td><p>Handlebars</p></td><td><p>Components</p></td></tr><tr><td><p>Bottom Brackets</p></td><td><p>Components</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>And now we are done!</p><p><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara">While refactoring our query, we made the following enhancements to our schema.
You can try the following on your REPL and verify that no error is raised.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductCategory</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">ProductCategory</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p></blockquote></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/08109d80b869a230ea4af824578aba2ede359ce2?diff=unified">here</a>.</p></blockquote></div></p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_2__Products___Subcategories___Categories&quot;">2.3.2<tt>&nbsp;</tt><a name="(part._.Task_2__.Products___.Subcategories___.Categories)"></a>Task 2: Products &amp; Subcategories &amp; Categories</h5><p><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of Products with Subcategory and Category names.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></p><p><div class="SIntrapara">We need to create a query.
The first step is to determine the table we need to query.
The <span class="RktSym">Product</span> table looks promising.
Let&rsquo;s see what it contains:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.*</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductID</p></td><td><p>Name</p></td><td><p>ProductNumber</p></td><td><p>MakeFlag</p></td><td><p>FinishedGoodsFlag</p></td><td><p>Color</p></td><td align="right"><p>SafetyStockLevel</p></td><td><p>ReorderPoint</p></td><td><p>StandardCost</p></td><td align="right"><p>ListPrice</p></td><td><p>Size</p></td><td><p>SizeUnitMeasureCode</p></td><td><p>WeightUnitMeasureCode</p></td><td><p>Weight</p></td><td><p>DaysToManufacture</p></td><td><p>ProductLine</p></td><td><p>Class</p></td><td><p>Style</p></td><td><p>ProductSubcategoryID</p></td><td><p>ProductModelID</p></td><td><p>SellStartDate</p></td><td><p>SellEndDate</p></td><td><p>DiscontinuedDate</p></td><td><p>rowguid</p></td><td><p>ModifiedDate</p></td></tr><tr><td><p>1</p></td><td><p>Adjustable Race</p></td><td><p>AR-5381</p></td><td><p>0</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td align="right"><p>1000</p></td><td><p>750</p></td><td><p>0</p></td><td align="right"><p>0.0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>2008-04-30 00:00:00</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>{694215B7-08F7-4C0D-ACB1-D734BA44C0C8}</p></td><td><p>2014-02-08 10:01:36.827000000</p></td></tr><tr><td><p>2</p></td><td><p>Bearing Ball</p></td><td><p>BA-8327</p></td><td><p>0</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td align="right"><p>1000</p></td><td><p>750</p></td><td><p>0</p></td><td align="right"><p>0.0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>2008-04-30 00:00:00</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>{58AE3C20-4F3A-4749-A7D4-D568806CC537}</p></td><td><p>2014-02-08 10:01:36.827000000</p></td></tr><tr><td><p>3</p></td><td><p>BB Ball Bearing</p></td><td><p>BE-2349</p></td><td><p>1</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td align="right"><p>800</p></td><td><p>600</p></td><td><p>0</p></td><td align="right"><p>0.0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>1</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>2008-04-30 00:00:00</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>{9C21AED2-5BFA-4F18-BCB8-F11638DC2E4E}</p></td><td><p>2014-02-08 10:01:36.827000000</p></td></tr><tr><td><p>4</p></td><td><p>Headset Ball Bearings</p></td><td><p>BE-2908</p></td><td><p>0</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td align="right"><p>800</p></td><td><p>600</p></td><td><p>0</p></td><td align="right"><p>0.0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>2008-04-30 00:00:00</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>{ECFED6CB-51FF-49B5-B06C-7D8AC834DB8B}</p></td><td><p>2014-02-08 10:01:36.827000000</p></td></tr><tr><td><p>316</p></td><td><p>Blade</p></td><td><p>BL-2036</p></td><td><p>1</p></td><td><p>0</p></td><td><p>#&lt;sql-null&gt;</p></td><td align="right"><p>800</p></td><td><p>600</p></td><td><p>0</p></td><td align="right"><p>0.0</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>1</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>2008-04-30 00:00:00</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>{E73E9750-603B-4131-89F5-3DD15ED5FF80}</p></td><td><p>2014-02-08 10:01:36.827000000</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p><div class="SIntrapara">It looks like ProductSubcategoryID is a foreign key to the ProductSubcategory table.
But at least some of the records have dbnull for their ProductSubcategoryID.
This means that not every Product belongs to a ProductSubcategory.
We create a join and use <span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="stt"> </span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span> to avoid eliminating
these Products from the result set:
</div><div class="SIntrapara"><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>The code <span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="stt"> </span><span class="RktSym">expr</span><span class="stt"> </span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span> says that "if expr is null, it
should not be considered equal to anything."
You can read more about this at <a href="Nullability.html" data-pltdoc="x">Nullability</a>.</p></blockquote></blockquote></blockquote></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Now we need to add some select clauses:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.Name as Name</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>Name</p></td><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td></tr><tr><td><p>Adjustable Race</p></td><td><p>AR-5381</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Bearing Ball</p></td><td><p>BA-8327</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>BB Ball Bearing</p></td><td><p>BE-2349</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Headset Ball Bearings</p></td><td><p>BE-2908</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Blade</p></td><td><p>BL-2036</p></td><td><p>#&lt;sql-null&gt;</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p><div class="SIntrapara">It looks like we are on the right track.
The top 5 rows have a null SubcategoryName, but this seems to be correct.
If you remove the <span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span> clause you will see some rows with non-null Subcategories.
Now we just need to include the name of the Category.
Hang on, we&rsquo;ve worked with <span class="RktSym">CategoryName</span> in the past, haven&rsquo;t we?
Let&rsquo;s see what it is defined for:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktVal">_</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">'(ProductCategory ProductSubcategory)</span></p></td></tr></table></blockquote></div></p><p>Sweet!
We can see that <span class="RktSym">CategoryName</span> is defined for <span class="RktSym">ProductSubcategory</span>.
We did this as part of the previous task&rsquo;s refactoring.
That investment pays off now, because our current query has an instance of
<span class="RktSym">ProductSubcategory</span>, so we can pass it into <span class="RktSym">CategoryName</span>:</p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.Name as Name</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">left join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>Name</p></td><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td></tr><tr><td><p>Adjustable Race</p></td><td><p>AR-5381</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Bearing Ball</p></td><td><p>BA-8327</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>BB Ball Bearing</p></td><td><p>BE-2349</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Headset Ball Bearings</p></td><td><p>BE-2908</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Blade</p></td><td><p>BL-2036</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>This query looks good!</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring</span></div><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._join1-~3eschema%29" data-pltdoc="x">Singular Join -&gt; Schema Definition</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">ProductSubcategory</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._join-~3einline%29" data-pltdoc="x">Inline Join</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="PStrike"><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="stt"> </span><span class="RktSym">subcat</span><span class="stt"> </span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">ProductSubcategory</span></span><span class="highlighted"><span class="stt"> </span></span><span class="highlighted"><span class="RktSym">prd</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">ProductSubcategory</span></span><span class="highlighted"><span class="hspace">&nbsp;</span></span><span class="highlighted"><span class="RktSym">prd</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">ProductSubcategory</span></span><span class="highlighted"><span class="hspace">&nbsp;</span></span><span class="highlighted"><span class="RktSym">prd</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._scalar-flattening%29" data-pltdoc="x">Scalar Flattening</a> recipe twice to create the following
equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Name</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">SubcategoryName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">CategoryName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>Use the <a href="Refactoring_Recipes.html#%28part._ds~3arename%29" data-pltdoc="x">Name Clarification</a> recipe to create the following equivalent query:</p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">ProductName</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.Name as ProductName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">left join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductName</p></td><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td></tr><tr><td><p>Adjustable Race</p></td><td><p>AR-5381</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Bearing Ball</p></td><td><p>BA-8327</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>BB Ball Bearing</p></td><td><p>BE-2349</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Headset Ball Bearings</p></td><td><p>BE-2908</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr><tr><td><p>Blade</p></td><td><p>BL-2036</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>#&lt;sql-null&gt;</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>And now we are done!</p><p><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara">While refactoring our query, we made the following enhancements to our schema.
You can try the following on your REPL and verify that no error is raised.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">ProductSubcategory</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p></blockquote></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/d7ec8d4c6b1b93703c3e41dd67439a1f8b2d67bb?diff=unified">here</a>.</p></blockquote></div></p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_3__Products_with_Non-Zero_Sales&quot;">2.3.3<tt>&nbsp;</tt><a name="(part._.Task_3__.Products_with_.Non-.Zero_.Sales)"></a>Task 3: Products with Non-Zero Sales</h5><p><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of Products that have non-zero sales,
with Subcategory and Category names.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></div><div class="SIntrapara">This just adds the "non-zero sales" criteria to the previous task.
Your boss explains that the Product catalog could use some culling, but for now
"has sales?" is an acceptable way to filter out obsolete Products.</div></p><p><div class="SIntrapara">How do we know whether a Product has been sold?
Remember our REPL tricks. We might want to see the list of tables again:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">tables</span><span class="RktPn">)</span></p></blockquote></div><div class="SIntrapara">It looks like the SalesOrderHeader and SalesOrderDetail tables are the main
suspects. Let&rsquo;s see what is defined for both of these tables:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">_</span><span class="hspace">&nbsp;</span><span class="RktVal">SalesOrderHeader</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">adventure-works-schema</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">(</span><span class="RktVal">_</span><span class="hspace">&nbsp;</span><span class="RktVal">SalesOrderDetail</span><span class="RktVal">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Aha, the SalesOrderDetail table has a ProductID column.
This seems to be the relationship we need to consider.
The presence of at least one SalesOrderDetail means that a Product has been sold.
With that in mind, we can write this query:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._exists%29%29" class="RktValLink" data-pltdoc="x">exists</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">dtl</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">dtl</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.Name as ProductName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">left join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">where exists (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select dtl.*</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail dtl</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">where (dtl.ProductID = prd.ProductID)</span></p></td></tr><tr><td><p><span class="stt">)</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductName</p></td><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td></tr><tr><td><p>Sport-100 Helmet, Red</p></td><td><p>HL-U509-R</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr><tr><td><p>Sport-100 Helmet, Black</p></td><td><p>HL-U509</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr><tr><td><p>Mountain Bike Socks, M</p></td><td><p>SO-B909-M</p></td><td><p>Socks</p></td><td><p>Clothing</p></td></tr><tr><td><p>Mountain Bike Socks, L</p></td><td><p>SO-B909-L</p></td><td><p>Socks</p></td><td><p>Clothing</p></td></tr><tr><td><p>Sport-100 Helmet, Blue</p></td><td><p>HL-U509-B</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>This query looks good!</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring</span></div><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._scalar-~3eschema%29" data-pltdoc="x">Scalar -&gt; Schema Definition</a> recipe to create the following equivalent query:</div></p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">HasSales?</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.Name as ProductName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">left join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">where exists (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select dtl.*</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail dtl</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">where (dtl.ProductID = prd.ProductID)</span></p></td></tr><tr><td><p><span class="stt">)</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductName</p></td><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td></tr><tr><td><p>Sport-100 Helmet, Red</p></td><td><p>HL-U509-R</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr><tr><td><p>Sport-100 Helmet, Black</p></td><td><p>HL-U509</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr><tr><td><p>Mountain Bike Socks, M</p></td><td><p>SO-B909-M</p></td><td><p>Socks</p></td><td><p>Clothing</p></td></tr><tr><td><p>Mountain Bike Socks, L</p></td><td><p>SO-B909-L</p></td><td><p>Socks</p></td><td><p>Clothing</p></td></tr><tr><td><p>Sport-100 Helmet, Blue</p></td><td><p>HL-U509-B</p></td><td><p>Helmets</p></td><td><p>Accessories</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>And now we are done!</p><p><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara">While refactoring our query, we made the following enhancements to our schema.
You can try the following on your REPL and verify that no error is raised.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">HasSales?</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></p></blockquote></div></p></blockquote></div><div class="SIntrapara">My solution for this section is
<a href="https://github.com/default-kramer/plisqin-tutorials/commit/b7c958498f1d24781583e48201f0e8a9e5a1aae6?diff=unified">here</a>.
<span style="font-weight: bold">Warning:</span> You might notice a small error in my solution.
I did not use a fallback around <span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._this%29%29" class="RktStxLink" data-pltdoc="x">this</a></span>, which will cause an error
if anyone passes a left join of the Product table into <span class="RktSym">HasSales?</span>.</div></p><p>Notice the encapsulation that <span class="RktPn">(</span><span class="RktSym">HasSales?</span><span class="stt"> </span><span class="RktSym">Product</span><span class="RktPn">)</span> provides.
Today it is implemented using <span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._exists%29%29" class="RktValLink" data-pltdoc="x">exists</a></span>, but in the future we might
decide to denormalize and add a HasSales column to the Product table.
The important point is that we can choose a different implementation
without breaking any calling code - the calling code will always remain
<span class="RktPn">(</span><span class="RktSym">HasSales?</span><span class="stt"> </span><span class="RktSym">product</span><span class="RktPn">)</span>.
This is not true in SQL - switching from an "exists" implementation to a
simple column access would require updating all the call sites.</p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_4__Sales_by_Product&quot;">2.3.4<tt>&nbsp;</tt><a name="(part._.Task_4__.Sales_by_.Product)"></a>Task 4: Sales by Product</h5><p><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of the best-selling Products of all time.
Sort by total revenue. Include total quantity sold and subcategory.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></p><p>So far, each query prior to refactoring has been similar to how you would
write the query using plain SQL.
This time, the initial query will use <a href="Aggregates.html#%28tech._grouped._join._aggregation%29" class="techoutside" data-pltdoc="x"><span class="techinside">grouped join aggregation</span></a>,
a technique that is unlike anything in SQL.
You don&rsquo;t need to understand this right now in order to perform the refactoring,
but if you are curious, the <a href="Aggregates.html" data-pltdoc="x">Aggregates</a> section should be next on
your reading list.</p><p>We need to create a query.
The first step is to determine the table we need to query.
This query will be of the Product table.
But in order to get "total revenue" and "total quantity sold", we will need
to use some aggregations.
We recall from the previous task that the SalesOrderDetail table points to
the Product table.
From the other direction, we can say that each Product has a group of
SalesOrderDetail records &ndash; the records whose ProductID matches the Product.
We build the <span class="RktSym">detailsG</span> <a href="Aggregates.html#%28tech._grouped._join%29" class="techoutside" data-pltdoc="x"><span class="techinside">grouped join</span></a> and perform aggregations
over it to solve this task.</p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._group-by%29%29" class="RktValLink" data-pltdoc="x">group-by</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">left join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select detailsG.ProductID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by detailsG.ProductID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 = prd.ProductID)</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>BK-M68B-38</p></td><td><p>Mountain Bikes</p></td><td><p>4400592.8</p></td><td><p>2977</p></td></tr><tr><td><p>BK-M68B-42</p></td><td><p>Mountain Bikes</p></td><td><p>4009494.76</p></td><td><p>2664</p></td></tr><tr><td><p>BK-M68S-38</p></td><td><p>Mountain Bikes</p></td><td><p>3693678.03</p></td><td><p>2394</p></td></tr><tr><td><p>BK-M68S-42</p></td><td><p>Mountain Bikes</p></td><td><p>3438478.86</p></td><td><p>2234</p></td></tr><tr><td><p>BK-M68S-46</p></td><td><p>Mountain Bikes</p></td><td><p>3434256.94</p></td><td><p>2216</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>This query looks good!</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring</span></div><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._join.G-~3eschema%29" data-pltdoc="x">Grouped Join -&gt; Schema Definition</a> recipe to create the following equivalent query:</div></p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">DetailsG</span></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">inner join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select detailsG.ProductID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by detailsG.ProductID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 = prd.ProductID)</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>BK-M68B-38</p></td><td><p>Mountain Bikes</p></td><td><p>4400592.8</p></td><td><p>2977</p></td></tr><tr><td><p>BK-M68B-42</p></td><td><p>Mountain Bikes</p></td><td><p>4009494.76</p></td><td><p>2664</p></td></tr><tr><td><p>BK-M68S-38</p></td><td><p>Mountain Bikes</p></td><td><p>3693678.03</p></td><td><p>2394</p></td></tr><tr><td><p>BK-M68S-42</p></td><td><p>Mountain Bikes</p></td><td><p>3438478.86</p></td><td><p>2234</p></td></tr><tr><td><p>BK-M68S-46</p></td><td><p>Mountain Bikes</p></td><td><p>3434256.94</p></td><td><p>2216</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>You might want to go further with the refactoring by using the
<a href="Refactoring_Recipes.html#%28part._join-~3einline%29" data-pltdoc="x">Inline Join</a> recipe to move <span class="RktSym">detailsG</span> inline, then using the
<a href="Refactoring_Recipes.html#%28part._scalar-~3eschema%29" data-pltdoc="x">Scalar -&gt; Schema Definition</a> recipe to define <span class="RktPn">(</span><span class="RktSym">TotalSales</span><span class="stt"> </span><span class="RktSym">Product</span><span class="RktPn">)</span>
and <span class="RktPn">(</span><span class="RktSym">TotalQtySold</span><span class="stt"> </span><span class="RktSym">Product</span><span class="RktPn">)</span>.
This might be a good idea, and you are welcome to do so.
But I am going to stop here for now.</p><p><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara">While refactoring our query, we made the following enhancements to our schema.
You can try the following on your REPL and verify that no error is raised.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span><span class="RktPn">)</span></p></blockquote></div></p></blockquote></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/8376dfee36a5c0411be76ca71c98082f0684295a?diff=unified">here</a>.</p></blockquote></div></p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_5__Sales_by_Subcategory&quot;">2.3.5<tt>&nbsp;</tt><a name="(part._.Task_5__.Sales_by_.Subcategory)"></a>Task 5: Sales by Subcategory</h5><p><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of the best-selling Subcategories of all time.
Sort by total revenue. Include total quantity sold and category name.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></p><p><div class="SIntrapara">This task is very similar to the previous task.
We need to create a query.
This query will be of the ProductSubcategory table.
In order to get "total revenue" and "total quantity sold", we will use
<a href="Aggregates.html#%28tech._grouped._join._aggregation%29" class="techoutside" data-pltdoc="x"><span class="techinside">grouped join aggregation</span></a> over the SalesOrderDetail table just as we
did in the previous task.
Again, you don&rsquo;t need to fully understand grouped join aggregation at this time.
You can take the initial query on faith; just make sure that the refactoring
makes sense to you.
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductID</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._group-by%29%29" class="RktValLink" data-pltdoc="x">group-by</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">left join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select prd.ProductSubcategoryID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">inner join Product prd</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductID = detailsG.ProductID)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by prd.ProductSubcategoryID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 is not null and (detailsG.__INJECT0 = subcat.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td><td><p>43909437.51</p></td><td><p>47196</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td><td><p>36445443.94</p></td><td><p>28321</p></td></tr><tr><td><p>Touring Bikes</p></td><td><p>Bikes</p></td><td><p>14296291.26</p></td><td><p>14751</p></td></tr><tr><td><p>Mountain Frames</p></td><td><p>Components</p></td><td><p>4713930.23</p></td><td><p>11621</p></td></tr><tr><td><p>Road Frames</p></td><td><p>Components</p></td><td><p>3851350.6</p></td><td><p>11753</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>This query looks good!</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring</span></div><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._join1-~3eschema%29" data-pltdoc="x">Singular Join -&gt; Schema Definition</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">Product</span></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._group-by%29%29" class="RktValLink" data-pltdoc="x">group-by</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._join-~3einline%29" data-pltdoc="x">Inline Join</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="PStrike"><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="stt"> </span><span class="RktSym">prd</span><span class="stt"> </span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">Product</span></span><span class="highlighted"><span class="stt"> </span></span><span class="highlighted"><span class="RktSym">detailsG</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._group-by%29%29" class="RktValLink" data-pltdoc="x">group-by</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">Product</span></span><span class="highlighted"><span class="hspace">&nbsp;</span></span><span class="highlighted"><span class="RktSym">detailsG</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="highlighted"><span class="RktPn">(</span></span><span class="highlighted"><span class="RktSym">Product</span></span><span class="highlighted"><span class="hspace">&nbsp;</span></span><span class="highlighted"><span class="RktSym">detailsG</span></span><span class="highlighted"><span class="RktPn">)</span></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Use the <a href="Refactoring_Recipes.html#%28part._scalar-flattening%29" data-pltdoc="x">Scalar Flattening</a> recipe to create the following equivalent query:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._join-type%29%29" class="RktValLink" data-pltdoc="x">join-type</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">left</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._group-by%29%29" class="RktValLink" data-pltdoc="x">group-by</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">ProductSubcategoryID</span></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._~3f~3f%29%29" class="RktStxLink" data-pltdoc="x">??</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">ProductSubcategoryID</span></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._%2Fvoid%29%29" class="RktValLink" data-pltdoc="x">/void</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>Use the <a href="Refactoring_Recipes.html#%28part._join.G-~3eschema%29" data-pltdoc="x">Grouped Join -&gt; Schema Definition</a> recipe to create the following equivalent query:</p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="PGreen"><span class="RktSym">DetailsG</span></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">inner join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select prd.ProductSubcategoryID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">inner join Product prd</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductID = detailsG.ProductID)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by prd.ProductSubcategoryID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 is not null and (detailsG.__INJECT0 = subcat.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td><td><p>43909437.51</p></td><td><p>47196</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td><td><p>36445443.94</p></td><td><p>28321</p></td></tr><tr><td><p>Touring Bikes</p></td><td><p>Bikes</p></td><td><p>14296291.26</p></td><td><p>14751</p></td></tr><tr><td><p>Mountain Frames</p></td><td><p>Components</p></td><td><p>4713930.23</p></td><td><p>11621</p></td></tr><tr><td><p>Road Frames</p></td><td><p>Components</p></td><td><p>3851350.6</p></td><td><p>11753</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p>Again, you might want to go further with the refactoring and define properties
like <span class="RktPn">(</span><span class="RktSym">TotalSales</span><span class="stt"> </span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span> and
<span class="RktPn">(</span><span class="RktSym">TotalQtySold</span><span class="stt"> </span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span>.
This might be a good idea, and you are welcome to do so.
But I am going to stop here for now.</p><p><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara">While refactoring our query, we made the following enhancements to our schema.
You can try the following on your REPL and verify that no error is raised.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">Product</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">ProductSubcategoryID</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p></blockquote></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/60fef3e0a3caca7216879097a7ffb4cfaddc7db4?diff=unified">here</a>.</p></blockquote></div></p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_6__Sales_by_Anything&quot;">2.3.6<tt>&nbsp;</tt><a name="(part._.Task_6__.Sales_by_.Anything)"></a>Task 6: Sales by Anything</h5><p><div class="SIntrapara">Let&rsquo;s look at the previous two tasks.
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of the best-selling Products of all time.
Sort by total revenue. Include total quantity sold and subcategory.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td align="left"><p><span style="font-style: italic">Show me a list of the best-selling Subcategories of all time.
Sort by total revenue. Include total quantity sold and category name.</span></p></td></tr><tr><td align="right"><blockquote class="SubFlow"><p>&ndash; your boss</p></blockquote></td></tr></table></div></p><p>We can generalize this to
<span style="font-style: italic">Show me a list of the best-selling THINGS of all time.
Sort by total revenue. Include total quantity sold and SOME_OTHER_STUFF.</span></p><p><div class="SIntrapara">Let&rsquo;s look at where we left the previous two tasks:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Sales by Product:</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Sales by Subcategory:</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Notice that the last few clauses of both queries are identical.
We could easily remove this duplication using a macro, but we can also use a regular
procedure if we recognize that queries are appendable.
By "appendable" I mean that a query has a list of clauses, and you can easily
add more clauses to an existing query.
The following example demonstrates this.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">original</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductName</span><span class="hspace">&nbsp;</span><span class="RktSym">p</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktSym">both-halves</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">This appends two more clauses to `first-half`</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=Equality.html%23%2528def._%2528%2528quote._%7E23%7E25kernel%2529._equal%7E3f%2529%2529&amp;version=8.6" class="RktValLink Sq" data-pltdoc="x">equal?</a></span><span class="hspace">&nbsp;</span><span class="RktSym">original</span><span class="hspace">&nbsp;</span><span class="RktSym">both-halves</span><span class="RktPn">)</span></td></tr><tr><td><p><span class="RktRes">#t</span></p></td></tr></table></blockquote></div></p><p><div class="SIntrapara">With this pattern in mind, we can make a procedure <span class="RktSym">sales-report</span> which
accepts a query and appends some clauses to it.
We will append the clauses that were common to the two previous tasks:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Now we can use this procedure to reimplement the Sales by Product report.
We just have to pass in the <span class="RktSym">first-half</span> as follows:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="hspace">&nbsp;</span><span class="RktSym">Product</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ProductNumber</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">prd</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select prd.ProductNumber as ProductNumber</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from Product prd</span></p></td></tr><tr><td><p><span class="stt">inner join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select detailsG.ProductID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by detailsG.ProductID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 = prd.ProductID)</span></p></td></tr><tr><td><p><span class="stt">left join ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductSubcategoryID is not null and (subcat.ProductSubcategoryID = prd.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>ProductNumber</p></td><td><p>SubcategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>BK-M68B-38</p></td><td><p>Mountain Bikes</p></td><td><p>4400592.8</p></td><td><p>2977</p></td></tr><tr><td><p>BK-M68B-42</p></td><td><p>Mountain Bikes</p></td><td><p>4009494.76</p></td><td><p>2664</p></td></tr><tr><td><p>BK-M68S-38</p></td><td><p>Mountain Bikes</p></td><td><p>3693678.03</p></td><td><p>2394</p></td></tr><tr><td><p>BK-M68S-42</p></td><td><p>Mountain Bikes</p></td><td><p>3438478.86</p></td><td><p>2234</p></td></tr><tr><td><p>BK-M68S-46</p></td><td><p>Mountain Bikes</p></td><td><p>3434256.94</p></td><td><p>2216</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p><div class="SIntrapara">We can do the same thing for the Sales by Subcategory report:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">inner join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select prd.ProductSubcategoryID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">inner join Product prd</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductID = detailsG.ProductID)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by prd.ProductSubcategoryID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 is not null and (detailsG.__INJECT0 = subcat.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td><td><p>43909437.51</p></td><td><p>47196</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td><td><p>36445443.94</p></td><td><p>28321</p></td></tr><tr><td><p>Touring Bikes</p></td><td><p>Bikes</p></td><td><p>14296291.26</p></td><td><p>14751</p></td></tr><tr><td><p>Mountain Frames</p></td><td><p>Components</p></td><td><p>4713930.23</p></td><td><p>11621</p></td></tr><tr><td><p>Road Frames</p></td><td><p>Components</p></td><td><p>3851350.6</p></td><td><p>11753</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><p>Interesting! The <span class="RktSym">sales-report</span> procedure accepts a query of any table
for which <span class="RktSym">DetailsG</span> is defined!
It appends some more clauses to create a larger query.</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Refactoring Recap</span></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/d23dbd050cf6158668828134450ca6d35c279472?diff=unified">here</a>.</p></blockquote></div></p><p>We didn&rsquo;t add anything to our schema definition in this section.</p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;Task_7__Sales_by_Anything_with_Date_Range&quot;">2.3.7<tt>&nbsp;</tt><a name="(part._.Task_7__.Sales_by_.Anything_with_.Date_.Range)"></a>Task 7: Sales by Anything with Date Range</h5><p><div class="SIntrapara">What else could we do with the <span class="RktSym">sales-report</span>?
Right now it is showing all-time sales.
We could modify it to accept a time window of sales to consider as follows:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:start-date</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">start-date</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:end-date</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">end-date</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">first-half</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">Like queries, joins are also appendable.</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">The following clauses are appended to the join</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">that (DetailsG x) returned:</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">soh</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderHeader</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._join-on%29%29" class="RktValLink" data-pltdoc="x">join-on</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3d%29%29" class="RktValLink" data-pltdoc="x">.=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SalesOrderID</span><span class="hspace">&nbsp;</span><span class="RktSym">soh</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SalesOrderID</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">start-date</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3e~3d%29%29" class="RktValLink" data-pltdoc="x">.&gt;=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderDate</span><span class="hspace">&nbsp;</span><span class="RktSym">soh</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">start-date</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">end-date</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3c%29%29" class="RktValLink" data-pltdoc="x">.&lt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderDate</span><span class="hspace">&nbsp;</span><span class="RktSym">soh</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">end-date</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">#:start-date</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._val%29%29" class="RktStxLink" data-pltdoc="x">val</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"2012-01-01"</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Ftypes..rkt%29._.Datetime~3f%29%29" class="RktValLink" data-pltdoc="x">Datetime?</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">#:end-date</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28form._%28%28lib._plisqin-lib%2Fstrict..rkt%29._val%29%29" class="RktStxLink" data-pltdoc="x">val</a></span><span class="hspace">&nbsp;</span><span class="RktVal">"2013-01-01"</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Ftypes..rkt%29._.Datetime~3f%29%29" class="RktValLink" data-pltdoc="x">Datetime?</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="hspace">&nbsp;</span><span class="RktSym">ProductSubcategory</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">SubcategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">CategoryName</span><span class="hspace">&nbsp;</span><span class="RktSym">subcat</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select subcat.Name as SubcategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, cat.Name as CategoryName</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, round(detailsG.__INJECT1, 2) as TotalSales</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">, detailsG.__INJECT2 as TotalQtySold</span></p></td></tr><tr><td><p><span class="stt">from ProductSubcategory subcat</span></p></td></tr><tr><td><p><span class="stt">inner join (</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">select prd.ProductSubcategoryID as __INJECT0</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.LineTotal) as __INJECT1</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">, sum(detailsG.OrderQty) as __INJECT2</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">from SalesOrderDetail detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">inner join SalesOrderHeader soh</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">on (soh.SalesOrderID = detailsG.SalesOrderID)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">inner join Product prd</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">on (prd.ProductID = detailsG.ProductID)</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">where (soh.OrderDate &gt;= '2012-01-01')</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="stt">and (soh.OrderDate &lt; '2013-01-01')</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">group by prd.ProductSubcategoryID</span></p></td></tr><tr><td><p><span class="stt">) detailsG</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (detailsG.__INJECT0 is not null and (detailsG.__INJECT0 = subcat.ProductSubcategoryID))</span></p></td></tr><tr><td><p><span class="stt">inner join ProductCategory cat</span></p></td></tr><tr><td><p><span class="stt"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="stt">on (subcat.ProductCategoryID is not null and (cat.ProductCategoryID = subcat.ProductCategoryID))</span></p></td></tr><tr><td><p><span class="stt">order by detailsG.__INJECT1 desc</span></p></td></tr><tr><td><p><span class="stt">limit 5</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>SubcategoryName</p></td><td><p>CategoryName</p></td><td><p>TotalSales</p></td><td><p>TotalQtySold</p></td></tr><tr><td><p>Road Bikes</p></td><td><p>Bikes</p></td><td><p>17193556.04</p></td><td><p>19460</p></td></tr><tr><td><p>Mountain Bikes</p></td><td><p>Bikes</p></td><td><p>11791959.8</p></td><td><p>9034</p></td></tr><tr><td><p>Road Frames</p></td><td><p>Components</p></td><td><p>1692467.03</p></td><td><p>5564</p></td></tr><tr><td><p>Mountain Frames</p></td><td><p>Components</p></td><td><p>1541340.67</p></td><td><p>3168</p></td></tr><tr><td><p>Wheels</p></td><td><p>Components</p></td><td><p>492218.86</p></td><td><p>3802</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote><p><div class="SIntrapara"><span class="SSubSubSubSection">Recap</span></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/27b393580f6c45f3bea881569135335dea49094c?diff=unified">here</a>.</p></blockquote></div></p><p>We didn&rsquo;t add anything to our schema definition in this section.</p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;ec3&quot;">2.3.7.1<tt>&nbsp;</tt><a name="(part._ec3)"></a>Extra Credit 1</h5><p><div class="SIntrapara">Apply the appropriate refactoring recipies so that <span class="RktSym">OrderDate</span> is
defined for <span class="RktSym">SalesOrderDetail</span>.
This allows you to refactor <span class="RktSym">sales-report</span> as follows:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=define.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fbase..rkt%2529._define%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">sales-report</span><span class="hspace">&nbsp;</span><span class="RktSym">some-query</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:start-date</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">start-date</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:end-date</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">end-date</span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._from%29%29" class="RktStxLink" data-pltdoc="x">from</a></span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="hspace">&nbsp;</span><span class="RktSym">some-query</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._limit%29%29" class="RktValLink" data-pltdoc="x">limit</a></span><span class="hspace">&nbsp;</span><span class="RktVal">5</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._join%29%29" class="RktStxLink" data-pltdoc="x">join</a></span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="hspace">&nbsp;</span><span class="RktSym">x</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">start-date</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3e~3d%29%29" class="RktValLink" data-pltdoc="x">.&gt;=</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderDate</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">start-date</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="https://download.racket-lang.org/releases/8.6/doc/local-redirect/index.html?doc=reference&amp;rel=when_unless.html%23%2528form._%2528%2528lib._racket%252Fprivate%252Fletstx-scheme..rkt%2529._when%2529%2529&amp;version=8.6" class="RktStxLink Sq" data-pltdoc="x">when</a></span><span class="hspace">&nbsp;</span><span class="RktSym">end-date</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._where%29%29" class="RktValLink" data-pltdoc="x">where</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict%2Foperators..rkt%29._~3c%29%29" class="RktValLink" data-pltdoc="x">.&lt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderDate</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">end-date</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._round%29%29" class="RktValLink" data-pltdoc="x">round</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">2</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalSales</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._select%29%29" class="RktValLink" data-pltdoc="x">select</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib.html#%28def._%28%28lib._plisqin-lib%2Fmain..rkt%29._~3e~3e%29%29" class="RktValLink" data-pltdoc="x">&gt;&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">OrderQty</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">#:as</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">TotalQtySold</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._order-by%29%29" class="RktValLink" data-pltdoc="x">order-by</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">desc</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-lib_strict.html#%28def._%28%28lib._plisqin-lib%2Fstrict..rkt%29._sum%29%29" class="RktValLink" data-pltdoc="x">sum</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">LineTotal</span><span class="hspace">&nbsp;</span><span class="RktSym">detailsG</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">Hint: First use the <a href="Refactoring_Recipes.html#%28part._join1-~3eschema%29" data-pltdoc="x">Singular Join -&gt; Schema Definition</a> recipe to define
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">SalesOrderHeader</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span><span class="RktPn">)</span></p></blockquote></div></p><p><div class="SIntrapara">Next use the <a href="Refactoring_Recipes.html#%28part._join-~3einline%29" data-pltdoc="x">Inline Join</a> recipe, and finally use the
<a href="Refactoring_Recipes.html#%28part._scalar-flattening%29" data-pltdoc="x">Scalar Flattening</a> recipe to define
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><p><span class="RktPn">(</span><span class="RktSym">OrderDate</span><span class="hspace">&nbsp;</span><span class="RktSym">SalesOrderDetail</span><span class="RktPn">)</span></p></blockquote></div></p><p><div class="SIntrapara"><span class="SSubSubSubSection">Answer Key</span></div><div class="SIntrapara"><blockquote class="SubFlow"><p>My solution for this section is <a href="https://github.com/default-kramer/plisqin-tutorials/commit/d6645f18cd0eac45addeaab12e689a2d4135ff74?diff=unified">here</a>.</p></blockquote></div></p><h5 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;ec1&quot;">2.3.7.2<tt>&nbsp;</tt><a name="(part._ec1)"></a>Extra Credit 2 (More Challenging)</h5><p>Extra Credit: Extend the definition of DetailsG so that it is defined for
the ProductCategory, SalesTerritory, and SalesPerson tables.
Try using <span class="RktSym">sales-report</span> with these tables.
Here are some hints:</p><p>The primary key of the ProductCategory table is ProductCategoryID,
so you will need to group the SalesOrderDetail records by ProductCategoryID.
You will need to join from SalesOrderDetail to Product to ProductSubcategory.
The ProductSubcategory table has a ProductCategoryID column.</p><p>The primary key of the SalesTerritory table is TerritoryID,
so you will need to group the SalesOrderDetail records by TerritoryID.
You will need to join from SalesOrderDetail to SalesOrderHeader.
The SalesOrderHeader table has a TerritoryID column.</p><p>The primary key of the SalesPerson table is BusinessEntityID.
There is a foreign key from SalesOrderHeader.SalesPersonID to
SalesPerson.BusinessEntityID.
You probably have already defined the join from SalesOrderDetail
to SalesOrderHeader.
This is sufficient to solve the task, but the SalesPerson table
does not contain much information.
If you want to see, for example, the full name of the SalesPerson you will
have to join to the Person table.</p><p><div class="SIntrapara"><span class="SSubSubSubSection">Answer Keys</span></div><div class="SIntrapara">Part 1: My definition of <span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="stt"> </span><span class="RktSym">ProductCategory</span><span class="RktPn">)</span> is
<a href="https://github.com/default-kramer/plisqin-tutorials/commit/04d12acd5b7740f7766dae8098af6c47667dc404?diff=unified">here</a>.</div></p><p>Part 2: My definition of <span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="stt"> </span><span class="RktSym">SalesTerritory</span><span class="RktPn">)</span> is
<a href="https://github.com/default-kramer/plisqin-tutorials/commit/2d401bf8a0e5f3231f758dbf80b7e981975c5266?diff=unified">here</a>.</p><p>Part 3: My definition of <span class="RktPn">(</span><span class="RktSym">DetailsG</span><span class="stt"> </span><span class="RktSym">SalesPerson</span><span class="RktPn">)</span> is
<a href="https://github.com/default-kramer/plisqin-tutorials/commit/99c76528616630a3de18b32fefec0541169f21be?diff=unified">here</a>.</p><h4 x-source-module="(lib &quot;plisqin-doc/scribblings/plisqin.scrbl&quot;)" x-source-pkg="plisqin" x-part-tag="&quot;schema-generation&quot;">2.4<tt>&nbsp;</tt><a name="(part._schema-generation)"></a>Appendix A: Generating the Initial Schema Definition</h4><p>Extracting table and column information for use with <span class="RktSym"><a href="plisqin-lib.html#%28form._%28%28lib._plisqin-lib%2Fmain..rkt%29._define-schema%29%29" class="RktStxLink" data-pltdoc="x">define-schema</a></span>
is currently an ad-hoc process.
Plisqin may make this easier in the future.
But it is already pretty easy if you are using SQL Server or PostgreSQL.</p><p>The AdventureWorks database is originally for SQL Server;
Plisqin provides a port of this database to SQLite.
So to generate the initial AdventureWorks schema, I ran
<a href="https://github.com/default-kramer/plisqin/blob/master/plisqin-doc/scribblings/adventure-works-checkpoints/gen-schema.sql">this query</a> against the SQL Server original.
This produces Racket code that just needs some simple text massaging.</p><p><div class="SIntrapara">If you have no choice but to use SQLite, you would probably have to write
a small program with some loops that uses "sqlite_master" and "pragma table_info".
But the following queries show that the data is available:
</div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktVal">"select type, name from sqlite_master where name like 'Business%'"</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">select type, name from sqlite_master where name like 'Business%'</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>type</p></td><td><p>name</p></td></tr><tr><td><p>table</p></td><td><p>BusinessEntity</p></td></tr><tr><td><p>table</p></td><td><p>BusinessEntityAddress</p></td></tr><tr><td><p>table</p></td><td><p>BusinessEntityContact</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div><div class="SIntrapara"><blockquote class="SubFlow"><p><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="stt">&gt; </span><span class="RktPn">(</span><span class="RktSym"><a href="plisqin-examples_adventure-works.html#%28def._%28%28lib._plisqin-examples%2Fadventure-works..rkt%29._show-table%29%29" class="RktValLink" data-pltdoc="x">aw:show-table</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="hspace">&nbsp;</span><span class="RktVal">"pragma table_info(BusinessEntity)"</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara"><table cellspacing="0" cellpadding="0" class="PTableContainer"><tr><td><table cellspacing="0" cellpadding="0" class="PTableWrapper show-results"><tr><td><p><span class="PShowTable">Show Table</span><span class="PShowSql">Show SQL</span></p></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PSql"><tr><td><table cellspacing="0" cellpadding="0" class="SVerbatim"><tr><td><p><span class="stt">pragma table_info(BusinessEntity)</span></p></td></tr></table></td></tr></table></td></tr><tr><td><table cellspacing="0" cellpadding="0" class="PQueryResults"><tr><td><p>cid</p></td><td><p>name</p></td><td><p>type</p></td><td><p>notnull</p></td><td><p>dflt_value</p></td><td><p>pk</p></td></tr><tr><td><p>0</p></td><td><p>BusinessEntityID</p></td><td><p>integer_id</p></td><td><p>1</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td></tr><tr><td><p>1</p></td><td><p>rowguid</p></td><td><p>text</p></td><td><p>1</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td></tr><tr><td><p>2</p></td><td><p>ModifiedDate</p></td><td><p>text</p></td><td><p>1</p></td><td><p>#&lt;sql-null&gt;</p></td><td><p>0</p></td></tr></table></td></tr></table></td></tr></table></div></p></blockquote></div></p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" id="searchbox" type="text" tabindex="1" placeholder="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;8.6&quot;, &quot;../&quot;);"/></form>&nbsp;&nbsp;<a href="../index-2.html" title="up to the documentation top" data-pltdoc="x" onclick="return GotoPLTRoot(&quot;8.6&quot;);">top</a><span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="Read_Me_First.html" title="backward to &quot;1 Read Me First&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Plisqin&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="Aggregates.html" title="forward to &quot;3 Aggregates&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body>
<!-- Mirrored from docs.racket-lang.org/plisqin/using-define-schema.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 07 Sep 2022 03:29:45 GMT -->
</html>